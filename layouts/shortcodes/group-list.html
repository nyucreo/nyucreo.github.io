{{/*  Shortcode: group-list
     Usage: {{< group-list columns="3" count="20" sort_by="title" order="asc" img_height="110px" gap="1.5rem" section="group" >}}
     Defaults:
       columns=3, count=0(=all), sort_by="title", order="asc", img_height="110px", gap="1.5rem", section="group"
*/}}

{{ $cols      := or (.Get "columns") "3" }}
{{ $count     := .Get "count" }}
{{ $sortBy    := or (.Get "sort_by") "title" }}
{{ $order     := or (.Get "order") "asc" }}
{{ $imgH      := or (.Get "img_height") "110px" }}
{{ $gap       := or (.Get "gap") "1.5rem" }}
{{ $section   := or (.Get "section") "group" }}

{{ $pages := where site.RegularPages "Section" $section }}

{{ if eq (lower $sortBy) "title" }}
  {{ $pages = $pages.ByTitle }}
{{ else if hasPrefix $sortBy "Params." }}
  {{ $paramKey := trim (replace $sortBy "Params." "") " " }}
  {{ $pages = $pages.ByParam $paramKey }}
{{ end }}

{{ if eq (lower $order) "desc" }}
  {{ $pages = $pages.Reverse }}
{{ end }}

{{ if $count }}
  {{ $pages = first (int $count) $pages }}
{{ end }}

<div id="research-groups-grid">
  <div class="research-groups-container"
       style="display:grid;grid-template-columns:repeat({{ $cols }},minmax(0,1fr));gap:{{ $gap }};align-items:start;">

    {{ range $pages }}
      <div class="research-group-card">
        <a href="{{ .RelPermalink }}" class="card-link"
           style="display:block;text-align:center;padding:12px;border:1px solid rgba(0,0,0,.08);border-radius:12px;">

          {{ $resource := .Resources.GetMatch "featured*" }}
          {{ if $resource }}
            <div class="card-image">
              {{ $image := $resource.Fit "300x200" }}
              <img src="{{ $image.RelPermalink }}" alt="{{ .Title }}" loading="lazy"
                   style="height:{{ $imgH }};object-fit:contain;display:block;margin:0 auto;">
            </div>

          {{ else if .Params.image }}
            {{ $src := "" }}
            {{ $pi := .Params.image }}
            {{ $t := printf "%T" $pi }}
            {{ if eq $t "string" }}
              {{ $src = $pi }}
            {{ else if (and (isset $pi "filename") (ne (index $pi "filename") "")) }}
              {{ $src = (printf "media/%s" (index $pi "filename")) }}
            {{ end }}
            {{ if ne $src "" }}
              <div class="card-image">
                <img src="{{ $src | relURL }}" alt="{{ .Title }}" loading="lazy"
                     style="height:{{ $imgH }};object-fit:contain;display:block;margin:0 auto;">
              </div>
            {{ end }}
          {{ end }}

          <div class="card-content" style="margin-top:.5rem;">
            <h3 class="card-title" style="font-size:1.05rem;margin:0;">{{ .Title }}</h3>
          </div>
        </a>
      </div>
    {{ end }}

  </div>
</div>
