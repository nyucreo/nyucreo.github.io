{{- /* 取出置顶/精选的研究方向，按 weight 排序 */ -}}
{{- $areas := where site.RegularPages "Section" "area" -}}
{{- $areas = where $areas ".Params.featured" true -}}
{{- $areas = $areas.ByParam "weight" -}}

<div class="research-areas">
  {{- range $idx, $area := $areas -}}

    {{- /* 收集该 area 关联的前两个项目 */ -}}
    {{- $areaProjects := slice -}}
    {{- range $slug := $area.Params.projects | default (slice) -}}
      {{- with (site.GetPage (printf "project/%s" $slug)) -}}
        {{- $areaProjects = $areaProjects | append . -}}
      {{- end -}}
    {{- end -}}
    {{- $two := first 2 $areaProjects -}}

    {{- /* 偶数行(0,2,4...)左侧显示 area，奇数行右侧显示 area */ -}}
    {{- $isEven := eq (mod $idx 2) 0 -}}

    <div class="area-row">
      {{- if $isEven -}}
        <!-- 偶数行：Area 在最左 -->
        <div class="area-card" href="{{ $area.RelPermalink }}">
          <div class="area-icon" style="background-color: {{ $area.Params.color }};">
            <i class="{{ $area.Params.icon_pack }} fa-{{ $area.Params.icon }}"></i>
          </div>
           <h3>{{ $area.Title }}</h3>
          <!-- {{ with $area.Params.summary }}<p>{{ . }}</p>{{ end }} -->
        </div>

        {{- range $p := $two -}}
          {{- $img := or ($p.Resources.GetMatch "**featured*") ($p.Resources.GetMatch "**cover*") -}}
          <div class="project-card">
            {{- if $img -}}
              <div class="project-image" style="background-image:url('{{ $img.RelPermalink }}');"></div>
            {{- else if $p.Params.image -}}
              {{- $pi := $p.Params.image -}}
              {{- if reflect.IsMap $pi -}}
                {{- $fallback := or (index $pi "filename") (index $pi "src") -}}
                {{- if $fallback }}<div class="project-image" style="background-image:url('{{ $fallback }}');"></div>{{ end -}}
              {{- else -}}
                <div class="project-image" style="background-image:url('{{ $pi }}');"></div>
              {{- end -}}
            {{- end -}}
            <div class="project-content">
              <h4><a href="{{ $p.RelPermalink }}">{{ $p.Title }}</a></h4>
              <!-- {{ with $p.Params.summary }}<p class="project-summary">{{ . }}</p>{{ end }} -->
            </div>
          </div>
        {{- end -}}

      {{- else -}}
        <!-- 奇数行：Area 在最右（先输出两个项目占据左两列） -->
        {{- range $p := $two -}}
          {{- $img := or ($p.Resources.GetMatch "**featured*") ($p.Resources.GetMatch "**cover*") -}}
          <div class="project-card">
            {{- if $img -}}
              <div class="project-image" style="background-image:url('{{ $img.RelPermalink }}');"></div>
            {{- else if $p.Params.image -}}
              {{- $pi := $p.Params.image -}}
              {{- if reflect.IsMap $pi -}}
                {{- $fallback := or (index $pi "filename") (index $pi "src") -}}
                {{- if $fallback }}<div class="project-image" style="background-image:url('{{ $fallback }}');"></div>{{ end -}}
              {{- else -}}
                <div class="project-image" style="background-image:url('{{ $pi }}');"></div>
              {{- end -}}
            {{- end -}}
            <div class="project-content">
              <h4><a href="{{ $p.RelPermalink }}">{{ $p.Title }}</a></h4>
              <!-- {{ with $p.Params.summary }}<p class="project-summary">{{ . }}</p>{{ end }} -->
            </div>
          </div>
        {{- end -}}

        <div class="area-card" href="{{ $area.RelPermalink }}">
          <div class="area-icon" style="background-color: {{ $area.Params.color }};">
            <i class="{{ $area.Params.icon_pack }} fa-{{ $area.Params.icon }}"></i>
          </div>
          <h3>{{ $area.Title }}</h3>
          <!-- {{ with $area.Params.summary }}<p>{{ . }}</p>{{ end }} -->
        </div>
      {{- end -}}
    </div>
  {{- end -}}
</div>

