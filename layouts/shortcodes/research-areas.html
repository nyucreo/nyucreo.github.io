<!-- {{- $areas := where site.RegularPages "Section" "area" -}}
{{- $areas = where $areas ".Params.featured" true -}}
{{- $areas = $areas.ByParam "weight" -}}

<div class="research-areas">
  {{- range $index, $area := $areas -}}
    {{- $projects := where site.RegularPages "Section" "project" -}}
    {{- $areaProjects := slice -}}
    {{- range $area.Params.projects -}}
      {{- $projectSlug := . -}}
      {{- range $projects -}}
        {{- if eq .File.BaseFileName $projectSlug -}}
          {{- $areaProjects = $areaProjects | append . -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
    
    <div class="area-row">
      <div class="area-card">
        <div class="area-icon" style="background-color: {{ $area.Params.color }};">
          <i class="{{ $area.Params.icon_pack }} fa-{{ $area.Params.icon }}"></i>
        </div>
        <h3>{{ $area.Title }}</h3>
        <p>{{ $area.Params.summary }}</p>
      </div>

      {{- range first 2 $areaProjects -}}
        <div class="project-card">
          {{- with .Params.image -}}
            <div class="project-image" style="background-image: url('{{ $.RelPermalink }}{{ .filename | default "featured.jpg" }}');"></div>
          {{- end -}}
          <div class="project-content">
            <h4>{{ .Title }}</h4>
            {{- with .Params.summary -}}
              <p class="project-summary">{{ . }}</p>
            {{- end -}}
          </div>
        </div>
      {{- end -}}
    </div>
  {{- end -}}
</div> -->

{{- /* 取出置顶/精选的研究方向，按 weight 排序 */ -}}
{{- $areas := where site.RegularPages "Section" "area" -}}
{{- $areas = where $areas ".Params.featured" true -}}
{{- $areas = $areas.ByParam "weight" -}}

<div class="research-areas">
  {{- range $idx, $area := $areas -}}

    {{- /* 基于 front matter 的 projects: ["slug1","slug2",...] 精确找项目页 */ -}}
    {{- $areaProjects := slice -}}
    {{- range $slug := $area.Params.projects | default (slice) -}}
      {{- $p := site.GetPage (printf "project/%s" $slug) -}}
      {{- with $p -}}
        {{- $areaProjects = $areaProjects | append . -}}
      {{- end -}}
    {{- end -}}

    <div class="area-row">
      <!-- Research Area Card -->
      <div class="area-card">
        <div class="area-icon" style="background-color: {{ $area.Params.color }};">
          <i class="{{ $area.Params.icon_pack }} fa-{{ $area.Params.icon }}"></i>
        </div>
        <h3>{{ $area.Title }}</h3>
        {{ with $area.Params.summary }}<p>{{ . }}</p>{{ end }}
      </div>

      <!-- Project Cards -->
      {{- range first 2 $areaProjects -}}
        {{- /* 优先抓取 bundle 内资源，其次读 params.image 兜底 */ -}}
        {{- $img := or (.Resources.GetMatch "**featured*") (.Resources.GetMatch "**cover*") -}}
        {{- if not $img -}}
          {{- $pi := .Params.image -}}
          {{- /* 支持两种写法：image: "/path/x.jpg" 或 image: { filename: "featured.jpg" } */ -}}
          {{- if reflect.IsMap $pi -}}
            {{- $fname := or (index $pi "filename") (index $pi "src") -}}
            {{- if $fname -}}
              {{- $img = resources.Get $fname | default nil -}}
              {{- if not $img }}{{- /* 直接用字符串路径作为兜底 */ -}}{{- end -}}
            {{- end -}}
          {{- else if $pi -}}
            {{- /* 字符串写法 */ -}}
          {{- end -}}
        {{- end -}}

        <div class="project-card">
          {{- /* 背景图渲染：bundle 资源优先，其次直接用字符串路径 */ -}}
          {{- if $img -}}
            <div class="project-image" style="background-image:url('{{ $img.RelPermalink }}');"></div>
          {{- else if .Params.image -}}
            {{- $pi := .Params.image -}}
            {{- if reflect.IsMap $pi -}}
              {{- $fallback := or (index $pi "filename") (index $pi "src") -}}
              {{- if $fallback }}<div class="project-image" style="background-image:url('{{ $fallback }}');"></div>{{ end -}}
            {{- else -}}
              <div class="project-image" style="background-image:url('{{ $pi }}');"></div>
            {{- end -}}
          {{- end -}}

          <div class="project-content">
            <h4><a href="{{ .RelPermalink }}">{{ .Title }}</a></h4>
            {{- with .Params.summary -}}
              <p class="project-summary">{{ . }}</p>
            {{- end -}}
          </div>
        </div>
      {{- end -}}
    </div>
  {{- end -}}
</div>
